var request = require('request');

var emailjs = new function()
{
	var self = this;

	this.version = "NPM.1.5";
	this.secure = true;
	this.server = "api.emailjs.com";
	
	this.init = function(user_id, server, secure)
	{
		self.user_id = user_id;

		if (typeof server != 'undefined')
			self.server = server;

		if (typeof secure != 'undefined')
			self.secure = secure;

	}


	this.send = function(service_id, template_id, template_params, user_id)
	{
		var protocol = self.secure ? "https:" : "http:";
		var url = [protocol,'',self.server,"api/v1.0/email/send"].join('/');

		return new Promise(function(resolve, reject) {
			var send_params = {
				lib_version: self.version,
				user_id: user_id || self.user_id,
				service_id: service_id,
				template_id: template_id,
				template_params: template_params
			}

			request.post(
			    { 	method: 'POST',
			    	uri: url,
			    	json: true,
			    	headers: {
					    'Content-type': 'application/json;charset=UTF-8'
					},
					body: send_params
			    },
			 	function (error, response, body) {
					if (response.statusCode == 200 || (typeof(response.statusCode) == 'undefined' && body == 'OK')) {
							resolve({status: response.statusCode, text: body});
					}
					else {
							reject({status: response.statusCode, text: body});
					}

			    }
			);



			// req.send(JSON.stringify(send_params));
		}); // promise
	} // send


} // emailJS


module.exports = emailjs;